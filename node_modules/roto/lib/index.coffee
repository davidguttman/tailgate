director = require './vendor/director'
Router = director.Router

routerHelper = require './helpers'

router = null

module.exports = (target, routingTable) ->
  return router if router

  router = new Router
  router.updateParams = routerHelper.updateParams
  router.ensureParams = routerHelper.ensureParams

  router.param 'json', routerHelper.jsonRegex

  router.configure 
    before: [routerHelper.setPath, routerHelper.setParams]
    notfound: ->
      console.log 'arguments', arguments
      console.log 'route not found'
      window.location.hash = '/'
  
  router.target = target

  router.mount routingTable

  dispatchCopy = router.dispatch
  router.dispatch = (method, fragment) ->
    dispatchCopy.call this, method, unescape fragment

  router.init()
  
  if window.location.hash is ''
    window.location.hash = '/'

  return router